# name: test/sql/duck_hunt_phase3a.test
# description: Test multi-file glob pattern processing
# group: [sql]

require duck_hunt

# Test single file processing (backward compatibility)
query III
SELECT COUNT(*) as events,
       COUNT(CASE WHEN status = 'PASS' THEN 1 END) as passes,
       COUNT(CASE WHEN status = 'FAIL' THEN 1 END) as failures
FROM read_duck_hunt_log('workspace/ansible_sample.txt', 'auto');
----
109	53	0

# Test multi-file glob pattern processing - verify both file types exist
query I
SELECT COUNT(DISTINCT tool_name) as distinct_tools
FROM read_duck_hunt_log('workspace/builds/**/*.txt', 'auto');
----
2

# Test CI logs file processing (verify individual pytest files can be read)
query I
SELECT COUNT(*) as events_found
FROM read_duck_hunt_log('workspace/ci-logs/staging/pytest-results.txt', 'pytest_text');
----
4

# Test aggregation of events across all build files
query III
SELECT
    COUNT(*) as total_events,
    COUNT(CASE WHEN status = 'FAIL' THEN 1 END) as total_failures,
    COUNT(CASE WHEN status = 'PASS' THEN 1 END) as total_passes
FROM read_duck_hunt_log('workspace/builds/**/*.txt', 'auto');
----
18	0	8

# Test empty results for non-existent patterns
query I
SELECT COUNT(*) FROM read_duck_hunt_log('workspace/nonexistent/**/*.txt', 'auto');
----
0
