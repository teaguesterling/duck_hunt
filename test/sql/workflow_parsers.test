# name: test/sql/workflow_parsers.test
# description: Test workflow log parsing functionality
# group: [sql]

# Require statement will ensure this test is run with this extension loaded
require duck_hunt

# Test GitHub Actions parser (only meaningful events are emitted)
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_github_actions.log', 'github_actions');
----
11

# Test GitLab CI parser (only meaningful events are emitted)
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_gitlab_ci.log', 'gitlab_ci');
----
8

# Test Jenkins parser (only meaningful events are emitted)
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_jenkins.log', 'jenkins');
----
23

# Test Docker parser (only meaningful events are emitted)
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_docker.log', 'docker_build');
----
21

# Test auto-detection for GitHub Actions
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_github_actions.log', 'auto') WHERE workflow_type = 'github_actions';
----
11

# Test auto-detection for GitLab CI
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_gitlab_ci.log', 'auto') WHERE workflow_type = 'gitlab_ci';
----
8

# Test auto-detection for Jenkins
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_jenkins.log', 'auto') WHERE workflow_type = 'jenkins';
----
23

# Test auto-detection for Docker
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_docker.log', 'auto') WHERE workflow_type = 'docker_build';
----
21

# Test workflow hierarchy levels
query I
SELECT DISTINCT hierarchy_level FROM read_duck_hunt_workflow_log('test/sample_github_actions.log', 'github_actions') ORDER BY hierarchy_level;
----
3

# Test workflow metadata extraction
query II
SELECT DISTINCT workflow_type, tool_name FROM read_duck_hunt_workflow_log('test/sample_github_actions.log', 'github_actions') LIMIT 1;
----
github_actions	github_actions

# Test unit names are extracted (Schema V2: step_name -> unit)
# Now includes "Job Level" pseudo-step for job-level events
query I
SELECT COUNT(DISTINCT unit) FROM read_duck_hunt_workflow_log('test/sample_github_actions.log', 'github_actions') WHERE unit IS NOT NULL AND unit <> '';
----
4

# Test group names are extracted (Schema V2: job_name -> group)
query I
SELECT COUNT(DISTINCT "group") FROM read_duck_hunt_workflow_log('test/sample_jenkins.log', 'jenkins') WHERE "group" IS NOT NULL AND "group" <> '';
----
1

# Test GitHub Actions workflow commands detection
# Issue #35: Parser should detect ##[error], ##[warning], ##[notice] workflow commands

# Test ##[error] is detected as severity=error
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_github_actions_workflow_commands.log', 'github_actions') WHERE severity = 'error' AND message LIKE '%##[error]%';
----
1

# Test ##[warning] is detected as severity=warning
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_github_actions_workflow_commands.log', 'github_actions') WHERE severity = 'warning' AND message LIKE '%##[warning]%';
----
2

# Test ##[notice] is detected as severity=info (notice maps to info)
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_github_actions_workflow_commands.log', 'github_actions') WHERE severity = 'info' AND message LIKE '%##[notice]%';
----
1

# Test FAILED: keyword is still detected as error
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_github_actions_workflow_commands.log', 'github_actions') WHERE severity = 'error' AND message LIKE '%FAILED:%';
----
1

# Test total error count (##[error] + FAILED:)
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_github_actions_workflow_commands.log', 'github_actions') WHERE severity = 'error';
----
2

# Test total warning count
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_github_actions_workflow_commands.log', 'github_actions') WHERE severity = 'warning';
----
2

# =============================================================================
# WORKFLOW DELEGATION TESTS
# Issue #36: Workflow parsers should delegate to specialized parsers
# =============================================================================

# -----------------------------------------------------------------------------
# GitHub Actions Delegation
# When a step runs "Run make release", the output should be parsed by make_error
# -----------------------------------------------------------------------------

# Test GitHub Actions delegation - delegated events have hierarchy_level = 4
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_github_actions_delegation.log', 'github_actions') WHERE hierarchy_level = 4;
----
2

# Test GitHub Actions delegation - structured_data contains delegated format
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_github_actions_delegation.log', 'github_actions') WHERE structured_data = 'make_error';
----
2

# Test GitHub Actions delegation - tool_name is from delegated parser
query I
SELECT COUNT(DISTINCT tool_name) FROM read_duck_hunt_workflow_log('test/sample_github_actions_delegation.log', 'github_actions') WHERE tool_name IN ('make', 'github_actions');
----
2

# Test GitHub Actions delegation - delegated events preserve workflow context
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_github_actions_delegation.log', 'github_actions') WHERE hierarchy_level = 4 AND scope IS NOT NULL AND "group" IS NOT NULL;
----
2

# -----------------------------------------------------------------------------
# Jenkins Delegation
# When a step runs "+ make release", the output should be parsed by make_error
# -----------------------------------------------------------------------------

# Test Jenkins delegation - delegated events have hierarchy_level = 4
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_jenkins_delegation.log', 'jenkins') WHERE hierarchy_level = 4;
----
3

# Test Jenkins delegation - structured_data contains delegated format
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_jenkins_delegation.log', 'jenkins') WHERE structured_data = 'make_error';
----
3

# Test Jenkins delegation - tool_name is from delegated parser
query II
SELECT tool_name, COUNT(*) as cnt FROM read_duck_hunt_workflow_log('test/sample_jenkins_delegation.log', 'jenkins') WHERE tool_name = 'make' GROUP BY tool_name;
----
make	3

# -----------------------------------------------------------------------------
# GitLab CI Delegation
# When a stage runs "$ flake8 src/", the output should be parsed by flake8_text
# -----------------------------------------------------------------------------

# Test GitLab CI delegation - delegated events have hierarchy_level = 4
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_gitlab_ci_delegation.log', 'gitlab_ci') WHERE hierarchy_level = 4;
----
5

# Test GitLab CI delegation - structured_data contains delegated format
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_gitlab_ci_delegation.log', 'gitlab_ci') WHERE structured_data = 'flake8_text';
----
5

# Test GitLab CI delegation - tool_name is from delegated parser
query II
SELECT tool_name, COUNT(*) as cnt FROM read_duck_hunt_workflow_log('test/sample_gitlab_ci_delegation.log', 'gitlab_ci') WHERE tool_name = 'flake8' GROUP BY tool_name;
----
flake8	5

# -----------------------------------------------------------------------------
# Docker Delegation
# When a RUN command runs "make build", the output should be parsed by make_error
# -----------------------------------------------------------------------------

# Test Docker delegation - delegated events have hierarchy_level = 4
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_docker_delegation.log', 'docker_build') WHERE hierarchy_level = 4;
----
1

# Test Docker delegation - structured_data contains delegated format
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_docker_delegation.log', 'docker_build') WHERE structured_data = 'make_error';
----
1

# Test Docker delegation - warning from make is captured
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_docker_delegation.log', 'docker_build') WHERE severity = 'warning' AND structured_data = 'make_error';
----
1

# -----------------------------------------------------------------------------
# Pytest Delegation (verifies JSON/text priority fix)
# When a step runs "Run pytest tests/", it should delegate to pytest_text
# (not pytest_json which has higher priority but no command patterns)
# -----------------------------------------------------------------------------

# Test pytest delegation - delegated events have hierarchy_level = 4
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_github_actions_pytest.log', 'github_actions') WHERE hierarchy_level = 4;
----
4

# Test pytest delegation - structured_data is pytest_text (not pytest_json)
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_github_actions_pytest.log', 'github_actions') WHERE structured_data = 'pytest_text';
----
4

# Test pytest delegation - tool_name is from delegated parser
query II
SELECT tool_name, COUNT(*) as cnt FROM read_duck_hunt_workflow_log('test/sample_github_actions_pytest.log', 'github_actions') WHERE tool_name = 'pytest' GROUP BY tool_name;
----
pytest	4

# Test pytest delegation - test results are captured with correct status
query II
SELECT severity, COUNT(*) as cnt FROM read_duck_hunt_workflow_log('test/sample_github_actions_pytest.log', 'github_actions') WHERE structured_data = 'pytest_text' GROUP BY severity ORDER BY severity;
----
error	2
info	2