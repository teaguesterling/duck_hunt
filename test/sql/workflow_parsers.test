# name: test/sql/workflow_parsers.test
# description: Test workflow log parsing functionality
# group: [sql]

# Require statement will ensure this test is run with this extension loaded
require duck_hunt

# Test GitHub Actions parser (only meaningful events are emitted)
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_github_actions.log', 'github_actions');
----
11

# Test GitLab CI parser (only meaningful events are emitted)
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_gitlab_ci.log', 'gitlab_ci');
----
8

# Test Jenkins parser (only meaningful events are emitted)
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_jenkins.log', 'jenkins');
----
23

# Test Docker parser (only meaningful events are emitted)
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_docker.log', 'docker_build');
----
21

# Test auto-detection for GitHub Actions
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_github_actions.log', 'auto') WHERE workflow_type = 'github_actions';
----
11

# Test auto-detection for GitLab CI
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_gitlab_ci.log', 'auto') WHERE workflow_type = 'gitlab_ci';
----
8

# Test auto-detection for Jenkins
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_jenkins.log', 'auto') WHERE workflow_type = 'jenkins';
----
23

# Test auto-detection for Docker
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_docker.log', 'auto') WHERE workflow_type = 'docker_build';
----
21

# Test workflow hierarchy levels
query I
SELECT DISTINCT hierarchy_level FROM read_duck_hunt_workflow_log('test/sample_github_actions.log', 'github_actions') ORDER BY hierarchy_level;
----
3

# Test workflow metadata extraction
query II
SELECT DISTINCT workflow_type, tool_name FROM read_duck_hunt_workflow_log('test/sample_github_actions.log', 'github_actions') LIMIT 1;
----
github_actions	github_actions

# Test unit names are extracted (Schema V2: step_name -> unit)
# Now includes "Job Level" pseudo-step for job-level events
query I
SELECT COUNT(DISTINCT unit) FROM read_duck_hunt_workflow_log('test/sample_github_actions.log', 'github_actions') WHERE unit IS NOT NULL AND unit <> '';
----
4

# Test group names are extracted (Schema V2: job_name -> group)
query I
SELECT COUNT(DISTINCT "group") FROM read_duck_hunt_workflow_log('test/sample_jenkins.log', 'jenkins') WHERE "group" IS NOT NULL AND "group" <> '';
----
1

# Test GitHub Actions workflow commands detection
# Issue #35: Parser should detect ##[error], ##[warning], ##[notice] workflow commands

# Test ##[error] is detected as severity=error
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_github_actions_workflow_commands.log', 'github_actions') WHERE severity = 'error' AND message LIKE '%##[error]%';
----
1

# Test ##[warning] is detected as severity=warning
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_github_actions_workflow_commands.log', 'github_actions') WHERE severity = 'warning' AND message LIKE '%##[warning]%';
----
2

# Test ##[notice] is detected as severity=info (notice maps to info)
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_github_actions_workflow_commands.log', 'github_actions') WHERE severity = 'info' AND message LIKE '%##[notice]%';
----
1

# Test FAILED: keyword is still detected as error
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_github_actions_workflow_commands.log', 'github_actions') WHERE severity = 'error' AND message LIKE '%FAILED:%';
----
1

# Test total error count (##[error] + FAILED:)
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_github_actions_workflow_commands.log', 'github_actions') WHERE severity = 'error';
----
2

# Test total warning count
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_github_actions_workflow_commands.log', 'github_actions') WHERE severity = 'warning';
----
2