# name: test/sql/workflow_parsers.test
# description: Test workflow log parsing functionality
# group: [sql]

# Require statement will ensure this test is run with this extension loaded
require duck_hunt

# Test GitHub Actions parser
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_github_actions.log', 'github_actions');
----
26

# Test GitLab CI parser
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_gitlab_ci.log', 'gitlab_ci');
----
40

# Test Jenkins parser
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_jenkins.log', 'jenkins');
----
31

# Test Docker parser
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_docker.log', 'docker_build');
----
22

# Test auto-detection for GitHub Actions
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_github_actions.log', 'auto') WHERE workflow_type = 'github_actions';
----
26

# Test auto-detection for GitLab CI
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_gitlab_ci.log', 'auto') WHERE workflow_type = 'gitlab_ci';
----
40

# Test auto-detection for Jenkins
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_jenkins.log', 'auto') WHERE workflow_type = 'jenkins';
----
31

# Test auto-detection for Docker
query I
SELECT COUNT(*) FROM read_duck_hunt_workflow_log('test/sample_docker.log', 'auto') WHERE workflow_type = 'docker_build';
----
22

# Test workflow hierarchy levels
query I
SELECT DISTINCT hierarchy_level FROM read_duck_hunt_workflow_log('test/sample_github_actions.log', 'github_actions') ORDER BY hierarchy_level;
----
2
3

# Test workflow metadata extraction
query II
SELECT DISTINCT workflow_type, tool_name FROM read_duck_hunt_workflow_log('test/sample_github_actions.log', 'github_actions') LIMIT 1;
----
github_actions	github_actions

# Test unit names are extracted (Schema V2: step_name -> unit)
query I
SELECT COUNT(DISTINCT unit) FROM read_duck_hunt_workflow_log('test/sample_github_actions.log', 'github_actions') WHERE unit IS NOT NULL AND unit != '';
----
4

# Test group names are extracted (Schema V2: job_name -> group)
query I
SELECT COUNT(DISTINCT "group") FROM read_duck_hunt_workflow_log('test/sample_jenkins.log', 'jenkins') WHERE "group" IS NOT NULL AND "group" != '';
----
1