# name: test/sql/long_line_handling.test
# description: Test that parsers handle very long lines without crashing (regression test for segfault)
# group: [sql]

require duck_hunt

# Test 1: CMake parser handles file with very long lines without crashing
# This is a regression test for a segfault caused by catastrophic regex backtracking
statement ok
CREATE TABLE long_line_results AS
SELECT * FROM read_duck_hunt_log('workspace/long_line_sample.txt', 'cmake');

# Test 2: Verify we got results (parser didn't crash and processed the file)
query I
SELECT COUNT(*) > 0 as has_results FROM long_line_results;
----
true

# Test 3: Verify CMake Error lines are parsed correctly (cmake parser handles these)
query II
SELECT ref_line, category
FROM long_line_results
WHERE message LIKE '%CMake Error at%'
LIMIT 1;
----
42	configuration

# Test 4: Use gcc_text parser for GCC diagnostics in the same file
statement ok
CREATE TABLE gcc_long_line_results AS
SELECT * FROM read_duck_hunt_log('workspace/long_line_sample.txt', 'gcc_text');

# Test 4b: Verify normal error lines are parsed by gcc_text
query III
SELECT ref_file, ref_line, severity
FROM gcc_long_line_results
WHERE message LIKE '%undefined reference to%main%'
LIMIT 1;
----
/path/to/file.cpp	42	error

# Test 4c: Verify normal warning lines are parsed by gcc_text
query III
SELECT ref_file, ref_line, severity
FROM gcc_long_line_results
WHERE message LIKE '%unused variable%'
LIMIT 1;
----
/path/to/file.cpp	55	warning

# Test 5: Verify CMake Error is parsed
query II
SELECT category, severity
FROM long_line_results
WHERE message LIKE '%CMake Error%'
LIMIT 1;
----
configuration	error

# Test 6: Verify CMake Warning is parsed
query II
SELECT category, severity
FROM long_line_results
WHERE message LIKE '%CMake Warning at%message%'
LIMIT 1;
----
configuration	warning

# Test 7: Verify CMake Deprecation Warning is parsed (the specific pattern that was failing)
query II
SELECT category, severity
FROM long_line_results
WHERE message LIKE '%CMake Deprecation Warning%'
LIMIT 1;
----
configuration	warning

# Test 8: cmake parser now only parses cmake-specific lines (not GCC/linker errors)
# Count CMake-specific events
query I
SELECT COUNT(*) >= 3 as sufficient_cmake_events FROM long_line_results;
----
true

# Test 9: Verify gcc_text parser captured the linker-style errors
query I
SELECT COUNT(*) FROM gcc_long_line_results
WHERE message LIKE '%undefined reference%';
----
1

# Test 10: Count total gcc events
query I
SELECT COUNT(*) >= 3 as sufficient_gcc_events FROM gcc_long_line_results;
----
true

# Test 11: Auto-detection should work without crashing on long lines
statement ok
CREATE TABLE auto_detect_long AS
SELECT * FROM read_duck_hunt_log('workspace/long_line_sample.txt', 'auto');

query I
SELECT COUNT(*) > 0 as has_results FROM auto_detect_long;
----
true

# Clean up
statement ok
DROP TABLE long_line_results;

statement ok
DROP TABLE gcc_long_line_results;

statement ok
DROP TABLE auto_detect_long;
