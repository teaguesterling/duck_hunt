# name: external-tests/loghub_samples.test
# description: Test parsers against loghub real-world log samples (requires loghub submodule)
# group: [external]

require duck_hunt

# =============================================================================
# Loghub Sample Tests
# =============================================================================
# These tests use real-world log samples from the loghub repository
# (https://github.com/logpai/loghub) to verify parser reliability.

# =============================================================================
# Test 1: Linux Syslog - Parse entire 2k sample file
# =============================================================================

query I
SELECT COUNT(*) FROM read_duck_hunt_log('test/samples/loghub/Linux/Linux_2k.log', 'syslog');
----
2000

# Verify tool name detection
query I
SELECT DISTINCT tool_name FROM read_duck_hunt_log('test/samples/loghub/Linux/Linux_2k.log', 'syslog');
----
syslog

# =============================================================================
# Test 2: Linux Syslog - Auto-detection works
# =============================================================================

# Test single line detection
query I
SELECT duck_hunt_detect_format('Jun 14 15:16:01 combo sshd(pam_unix)[19939]: authentication failure; logname= uid=0 euid=0 tty=NODEVssh ruser= rhost=218.188.2.4');
----
syslog

# =============================================================================
# Test 3: Linux Syslog - Field extraction
# =============================================================================

# Verify origin (hostname) extraction
query I
SELECT COUNT(DISTINCT origin) >= 1 FROM read_duck_hunt_log('test/samples/loghub/Linux/Linux_2k.log', 'syslog');
----
true

# Verify process category extraction (sshd, su, etc.)
query I
SELECT COUNT(*) > 0 FROM read_duck_hunt_log('test/samples/loghub/Linux/Linux_2k.log', 'syslog')
WHERE category LIKE '%sshd%' OR category LIKE '%su%';
----
true

# =============================================================================
# Test 4: OpenSSH Syslog - Parse entire 2k sample file
# =============================================================================

query I
SELECT COUNT(*) FROM read_duck_hunt_log('test/samples/loghub/OpenSSH/OpenSSH_2k.log', 'syslog');
----
2000

# Verify tool name detection
query I
SELECT DISTINCT tool_name FROM read_duck_hunt_log('test/samples/loghub/OpenSSH/OpenSSH_2k.log', 'syslog');
----
syslog

# =============================================================================
# Test 5: OpenSSH - Security-relevant events
# =============================================================================

# Verify we capture authentication-related messages
query I
SELECT COUNT(*) > 100 FROM read_duck_hunt_log('test/samples/loghub/OpenSSH/OpenSSH_2k.log', 'syslog')
WHERE message LIKE '%Failed%' OR message LIKE '%Accepted%' OR message LIKE '%Invalid%';
----
true

# =============================================================================
# Test 6: Performance - Can process full loghub sample
# =============================================================================

# Both files together should process without error
query I
SELECT COUNT(*) = 4000 FROM (
    SELECT * FROM read_duck_hunt_log('test/samples/loghub/Linux/Linux_2k.log', 'syslog')
    UNION ALL
    SELECT * FROM read_duck_hunt_log('test/samples/loghub/OpenSSH/OpenSSH_2k.log', 'syslog')
);
----
true

# =============================================================================
# Test 7: HDFS - Parse and auto-detect
# =============================================================================

query I
SELECT COUNT(*) FROM read_duck_hunt_log('test/samples/loghub/HDFS/HDFS_2k.log', 'hdfs');
----
2000

# Auto-detection
query I
SELECT DISTINCT tool_name FROM read_duck_hunt_log('test/samples/loghub/HDFS/HDFS_2k.log');
----
hdfs

# =============================================================================
# Test 8: Spark - Parse and auto-detect
# =============================================================================

query I
SELECT COUNT(*) FROM read_duck_hunt_log('test/samples/loghub/Spark/Spark_2k.log', 'spark');
----
2000

# Auto-detection
query I
SELECT DISTINCT tool_name FROM read_duck_hunt_log('test/samples/loghub/Spark/Spark_2k.log');
----
spark

# =============================================================================
# Test 9: Android logcat - Parse and auto-detect
# =============================================================================

query I
SELECT COUNT(*) FROM read_duck_hunt_log('test/samples/loghub/Android/Android_2k.log', 'android');
----
2000

# Auto-detection
query I
SELECT DISTINCT tool_name FROM read_duck_hunt_log('test/samples/loghub/Android/Android_2k.log');
----
android

# =============================================================================
# Test 10: Zookeeper - Parse and auto-detect
# =============================================================================

query I
SELECT COUNT(*) FROM read_duck_hunt_log('test/samples/loghub/Zookeeper/Zookeeper_2k.log', 'zookeeper');
----
2000

# Auto-detection
query I
SELECT DISTINCT tool_name FROM read_duck_hunt_log('test/samples/loghub/Zookeeper/Zookeeper_2k.log');
----
zookeeper

# =============================================================================
# Test 11: OpenStack - Parse and auto-detect
# =============================================================================

query I
SELECT COUNT(*) FROM read_duck_hunt_log('test/samples/loghub/OpenStack/OpenStack_2k.log', 'openstack');
----
2000

# Auto-detection
query I
SELECT DISTINCT tool_name FROM read_duck_hunt_log('test/samples/loghub/OpenStack/OpenStack_2k.log');
----
openstack

# =============================================================================
# Test 12: BGL (Blue Gene/L) - Parse with explicit format
# =============================================================================

# BGL has some format variants, so we expect most but not all lines to parse
query I
SELECT COUNT(*) >= 1900 FROM read_duck_hunt_log('test/samples/loghub/BGL/BGL_2k.log', 'bgl');
----
true

# Verify tool name
query I
SELECT DISTINCT tool_name FROM read_duck_hunt_log('test/samples/loghub/BGL/BGL_2k.log', 'bgl');
----
bgl
